#!/usr/bin/env php
<?php
include(__DIR__ . '/../webdata/init.inc.php');

if ('git' !== getenv('USER')) {
    die('git user only' . PHP_EOL);
}

$public_keys = array(
    'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDH32ZXsqqw/t4w0YHJhsfdSaNQNmUBQj/aEzBKbqW4mNRY3CsEshtg95HZk2Lyo9KDP1g0ZRftilsXwHgFla80NJbIzP3UpSaNKembGPJmirXjyQNzar6ho3GpQP84ZGrYQW6sPUtHYY3XPEs6H7SOTTWSNZ757IEiIUaRglfZzwxe8lOxc5YxAQ6HL4XJNRd0mbdogdr3zIIY++WNylRQ0M+omHmsA+soD5AJBiCEy3BsS5IOc/k4nxCuDeLu15LcxC3SG5EFi1OTZ+eA2y0h/WmSoKF2ybwxgGTX5VLbwlqiStaqJqLMavE0bi+TzkUBzr8tEbgeo6v+DqWrg1cF www@m2',
);

$deploy_keys = array(
    'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC+Z2osqLn6QDgrjDsNrhjQi/QOTybkSkfTxb5xQ2q0uoAu12hIZVkepW99b7F2D3j6JdTLZT7/QLikPKtxDiXoIkgnqwjKiUknd9F1TKvADS0KGYz8dKFBHpnsvblnR709CtPinaopl1P6+tbl7k7WpV3Y146FHS5qGHxfX4lYERwUE1fD2XPk75kfq2aEl/qJhpVMvGgYXB21YahKFVAS6sbNxjDA8Gi1oLp6R/yRyqztdErXVrZo10gfInm23L7CdlZCMNQRkVT06wQc9JLbOSHDL1XqSp4IkinnysjeXRKzOuelxy1NNQ8EgVtrjXshl2BtC+eAoA9nKIDblIlt root@chttl-b16ca28e0c68ed5d',
    'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDjWfHl+o0EGBLpk96nEChKCj4hHODZBY2HmXBirRhnaSZXz8fEwCtY6yYhEPr/NxqZTYpvjyWsj8DNl9zl7uAZHGnF/6f7qLOTi8eU3hJS6NLD+g0IQe/5lDr/lN1auIG/5VBFB3Na1pY4FZRHzi68J8im5QeOXFwJ2tqA6CsvfIypCMaRbUvmx/M4sIaCH8vAt11RKRxk5Ylbqx8Jl0GQoZYW5gvdkjVS7UoWpsPRM+ku+Hl7PKLn5bCas5mX0jcnCc2kkaLC8sO9fyM0z1Jl3keutY9195QFEbh0Ye/Qyet2+Xi9oA2rTA7s9qHlHrBucgcEzMd0Fnnz2uf/qYXd root@chttl-b3f252dd4a5a916a',
    'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC8FBRaoJx7Us93gweXFUzCw60ZxIpbUOGBYHlIXngTPr+dXdLR+6wwsuWkKRQWTZkXXU5aRKSWgr+A30G1ZoI0j8SKPYfeM876WtM9LRl8S2xDMFchtRr2/uLnAhTuGzySwDPpO2W8ribG5qRZmzRmA7frskFnNCeVHm8sIHff7ICGibvvJ5ya744uTIszvRYwZ/kkhjnHXFwx9mR24Qr9tPcYTR4aXngZJOUFe33NeebZaV/vzqWPFZN4zNMnamrCjB/twkokIH1z5KIg9IlH8hISdO+yboGUvOD5NCPcRLoK1crFgMic4AYCYBJA4sMlfeqM+nVjqkvh/K3EruUp root@chttl-8d8f3fbaee6a4eb1', // 210.65.11.197
    'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC1XMHJuDM72/MlZ/jCyiKGpaNFKhOjz0t8kYjb+m0yTcbs2zjqqMV+7DRWDewtyX5ERnX2Wp2Mwa9SN2XVf9hz/YfMLi3FS7c1ZtLCfmDMzkw4lCAWO5WP7u0UqpfnWTR1iuCndKo/1/0qBLsKEbKZ4Dlil8yBqwkXOPGVd1oz+IBXy46ZQ7w1T/358d8wmhn+UjMtqZJef7T2deH4PTBQ6uH/ggbIYo+ESZpROprBibTgyIMD/ptItWxyLGxyE/A3gllqEEXnIqXAZtOXA6CldJ6m3zlNpQXTYSY/3XlF/wKY84vgrg9GAU11AyBmGIZXZmggAp4BcWsUtwVo79mX root@m2-nodes-1',
);


$content = '### generated at ' . date('Y/m/d H:i:s') . "\n";
$content .= "# deploy-keys\n";
foreach ($deploy_keys as $deploy_key) {
    $content .= 'command="/srv/code/hisoku/scripts/deploy-key-archive-only",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ' . $deploy_key . "\n";
}
$content .= "# update-keys\n";
foreach ($public_keys as $public_key) {
    $content .= 'command="/srv/code/hisoku/scripts/update-keys",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ' . $public_key . "\n";
}
$content .= "# user keys\n";
foreach (UserKey::search(1) as $user_key) {
    $content .= "command=\"/srv/code/hisoku/scripts/ssh-serve {$user_key->user->name} {$user_key->id}\",no-port-forwarding,no-X11-forwarding,no-agent-forwarding {$user_key->key_body}\n";
}

file_put_contents(getenv('HOME') . '/.ssh/authorized_keys', $content);
